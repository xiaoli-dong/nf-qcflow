/*
    Nextflow config: tuned for Genomics cluster
    Partitions:
        vm-cpu   → 64 GB nodes (general workloads)
        big-ram  → 162 GB node (medium memory jobs)
        huge-ram → 257 GB node (heavy memory, BAKTA full DB)
*/

/*
 * SAFETY FUNCTION: prevent resource overflow
 * Hard-coded max values to satisfy nf-core lint
 */
def check_max(obj, type) {
    if (type == 'memory') {
        def max_mem = 240.GB     // safe for vm-cpu/big-ram/huge-ram
        return (obj > max_mem) ? max_mem : obj
    } else if (type == 'time') {
        def max_time = 240.h
        return (obj > max_time) ? max_time : obj
    } else if (type == 'cpus') {
        def max_cpus = 24
        return Math.min(obj, max_cpus)
    }
}

/*
 * Default process settings
 */
process {
    executor = 'slurm'
    queue    = 'vm-cpu,big-ram,huge-ram'

    clusterOptions = {
        "-o slurm_logs_${task.process}.%j.out " +
        "-e slurm_logs_${task.process}.%j.err"
    }

    // Default resources for unlabeled tasks
    cpus   = { check_max(1 * task.attempt, 'cpus') }
    memory = { check_max(6.GB * task.attempt, 'memory') }
    time   = { check_max(4.h * task.attempt, 'time') }

    // Retry on OOM, signals, network failures
    errorStrategy = { task.exitStatus in ([1, 137, 143, 104] + (130..145)) ? 'retry' : 'finish' }
    maxRetries    = 3
    maxErrors     = -1

    //
    // LABELS
    //

    // Small jobs → vm-cpu (12 CPUs, ~64 GB)
    withLabel:process_single {
        cpus   = 1
        memory = { check_max(6.GB * task.attempt, 'memory') }
        time   = { check_max(1.h * task.attempt, 'time') }
    }

    withLabel:process_low {
        cpus   = 2
        memory = { check_max(12.GB * task.attempt, 'memory') }
        time   = { check_max(4.h * task.attempt, 'time') }
        maxRetries = 2
    }

    // Medium jobs → big-ram (24 CPUs, 162 GB)
    withLabel:process_medium {
        cpus   = 6
        memory = { check_max(48.GB * task.attempt, 'memory') }
        time   = { check_max(8.h * task.attempt, 'time') }
    }

    // High jobs → big-ram or huge-ram (24 CPUs)
    withLabel:process_high {
        cpus   = 8
        memory = { check_max(75.GB * task.attempt, 'memory') }
        time   = { check_max(16.h * task.attempt, 'time') }
        maxRetries = 3
    }

    // High memory jobs → huge-ram (24 CPUs, 257 GB)
    withLabel:process_high_memory {
        cpus   = 12
        memory = { check_max(120.GB * task.attempt, 'memory') }
        time   = { check_max(24.h * task.attempt, 'time') }
        maxRetries = 2
    }

    // Special error handling labels
    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }

    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    // Required by nf-core
    withName:CUSTOM_DUMPSOFTWAREVERSIONS {
        cache = false
    }
}
